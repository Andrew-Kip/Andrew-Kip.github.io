<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Unified Pressure Calculator + Resistance Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
  <style>
    :root{--bg:#f4f7fb;--left:#ffffff;--right:#ffffff;--accent:#2E8B57}
    body{font-family: 'Times New Roman', Times, serif;background:var(--bg);margin:0;padding:18px}
    .container{display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start}
    .panel{background:#fff;border-radius:8px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h2{margin:6px 0 12px;font-size:18px}
    label{display:block;margin-top:8px;font-size:14px}
    input[type=text]{width:100%;padding:8px;font-size:14px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    button{cursor:pointer;padding:10px 12px;border-radius:8px;border:none;font-weight:700}
    .btn-primary{background:#4682B4;color:white}
    .btn-green{background:var(--accent);color:white}
    .res-box{margin-top:10px;padding:8px;background:#222;color:#fff;border-radius:6px}
    .mode-row{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .charts-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .chart-card{background:#fafafa;padding:8px;border-radius:6px}
    .chart-title{font-size:12px;margin:6px 0}
    .small{font-size:12px}
    @media(max-width:900px){.container{grid-template-columns:1fr;}.charts-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="container">
    <!-- Left: Resistance Calculator -->
    <div class="panel" id="left-panel">
      <h2>Resistance Calculation</h2>
      <label>Length [m]:<input id="length" type="text" value="0.1"></label>
      <label>Radius [m]:<input id="radius" type="text" value="0.001"></label>
      <label>Viscosity [Pa·s]:<input id="viscosity" type="text" value="0.001"></label>
      <button id="calcRes" class="btn-primary" style="margin-top:12px">Calculate Resistance</button>
      <div class="res-box" id="resResult">R = </div>
    </div>

    <!-- Right: Main Pressure Calculator -->
    <div class="panel" id="right-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Unified Pressure Calculator (Positive / Negative)</h2>
      </div>

      <div class="mode-row">
        <div style="font-weight:700">Mode:</div>
        <label><input type="radio" name="mode" value="positive" checked> Positive Pressure</label>
        <label><input type="radio" name="mode" value="negative"> Negative Pressure</label>
      </div>

      <label>Target Pressure [psi gauge]:<input id="Pm" type="text" value="0"></label>
      <label>Time [s]:<input id="time" type="text" value="60"></label>
      <label>User Initial Volume [mL]:<input id="volume" type="text" value="1"></label>
      <label>Resistance [Pa·s/m²]:<input id="R" type="text" value="0.001"></label>

      <button id="genGraph" class="btn-green" style="margin-top:12px">Generate Graph</button>

      <div class="charts-grid" id="chartsGrid">
        <!-- six chart canvases will be injected here -->
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // ---- Constants ----
    const Po_psi = 14.7;
    const Po = Po_psi * 6894.76; // Pa
    const MAX_RUNTIME = 8_000; // ms per curve

    // Helper: parse float with fallback
    function toNum(v, fallback=0){ const n=parseFloat(v); return isFinite(n)?n:fallback }

    // Numerical solver (secant with safeguards)
    function solveSecant(func, x0, x1, tol=1e-6, maxIter=2000){
      let f0 = func(x0), f1 = func(x1);
      for(let i=0;i<maxIter;i++){
        if(Math.abs(f1) < tol) return x1;
        // avoid division by zero
        if(Math.abs(f1 - f0) < 1e-14) break;
        const x2 = x1 - f1 * (x1 - x0) / (f1 - f0);
        x0 = x1; f0 = f1; x1 = x2; f1 = func(x1);
      }
      return null;
    }

    // Positive pressure solver
    function calc_curve_positive(Pm, t, R, Vo_ml){
      const start = performance.now();
      const Vo = Vo_ml / 1e6;
      let Pi = Pm + 0.01;
      let Pt = 0.1; // initial

      function eqn(P, PiLocal){
        const A = Math.log(PiLocal - Po) - Math.log(PiLocal) + (Po / PiLocal);
        return Math.log(P - Po) - Math.log(P) + Po / P - (Po / (Vo * R)) * t - A;
      }

      let step = 0;
      while(Pt < Pm){
        if(performance.now() - start > MAX_RUNTIME) throw new Error(`Timeout for Vo=${Vo_ml} mL (positive mode)`);
        const guess0 = Math.max(Pm*0.9, Po+1);
        const guess1 = Math.max(Pm*1.01, Po+2);
        const sol = solveSecant(p=>eqn(p,Pi), guess0, guess1, 1e-6, 2000);
        if(sol===null || !isFinite(sol)){
          Pi += 0.01; step++;
          if(step>20000) throw new Error(`No convergence for Vo=${Vo_ml} mL`);
          continue;
        }
        Pt = sol;
        Pi += 0.01;
        step++;
        if(step>20000) throw new Error(`No convergence for Vo=${Vo_ml} mL`);
      }

      // Build data from Pt downward
      const A = Math.log(Pt - Po) - Math.log(Pt) + (Po / Pt);
      const data = [];
      let P = Pt;
      const dP = 0.01 * 6894.76;
      while(P > (Pi - (2 * 6894.76))){
        const t_graph = -(Vo * R / Po) * ((Math.log(P - Po) - Math.log(P) + (Po / P)) - A);
        data.push([t_graph, (P - Po) / 6894.76]);
        P -= dP;
        if(data.length>20000) break;
      }

      // Ensure last time >= t
      if(data.length===0){ data.push([0, (Pt - Po)/6894.76]); }
      if(data[data.length-1][0] < t){
        const lastP = data[data.length-1][1];
        data.push([t, lastP]);
      }
      const Vf = (Po / Pt) * Vo;
      const dV = (Vo - Vf) * 1e6; // mL
      const Pt_g = (Pt / 6894.76) - 14.7;
      return {data, dV, Pt_g};
    }

    // Negative pressure solver
    function calc_curve_negative(Pm, t, R, Vo_ml){
      const start = performance.now();
      const Vo = Vo_ml / 1e6;
      let Pi = Pm - 0.01;
      let Pt = Po - 100;

      function eqn(P, PiLocal){
        const A = Math.log(Po - PiLocal) - Math.log(Po) + (PiLocal / Po);
        return Math.log(Po - P) - Math.log(Po) + (P / Po) - (Po / (Vo * R)) * t - A;
      }

      let step=0;
      while(Pt > Pm){
        if(performance.now() - start > MAX_RUNTIME) throw new Error(`Timeout for Vo=${Vo_ml} mL (negative mode)`);
        const guess0 = Math.max(1, Pm*0.9);
        const guess1 = Math.max(1, Pm*1.05);
        const sol = solveSecant(p=>eqn(p,Pi), guess0, guess1, 1e-6, 2000);
        if(sol===null || !isFinite(sol)){
          Pi -= 0.01; step++;
          if(step>20000) throw new Error(`No convergence for Vo=${Vo_ml} mL`);
          continue;
        }
        Pt = sol;
        Pi -= 0.01;
        step++;
        if(step>20000) throw new Error(`No convergence for Vo=${Vo_ml} mL`);
      }

      const A = Math.log(Po - Pt) - Math.log(Po) + (Pt / Po);
      const data = [];
      let P = Pt;
      while(P < Po - 500){
        const t_graph = -(Vo * R / Po) * ((Math.log(Po - P) - Math.log(Po) + (P / Po)) - A);
        data.push([t_graph, (P - Po) / 6894.76]);
        P += 500;
        if(data.length>20000) break;
      }

      if(data.length===0){ data.push([0, (Pt - Po)/6894.76]); }
      if(data[data.length-1][0] < t){
        const lastP = data[data.length-1][1];
        data.push([t, lastP]);
      }
      const Vf = (Po / Pt) * Vo;
      const dV = Math.abs(Vo - Vf) * 1e6;
      const Pt_g = (Pt / 6894.76) - 14.7;
      return {data, dV, Pt_g};
    }

    // UI wiring
    document.getElementById('calcRes').addEventListener('click', ()=>{
      try{
        const length = toNum(document.getElementById('length').value);
        const radius = toNum(document.getElementById('radius').value);
        const viscosity = toNum(document.getElementById('viscosity').value);
        if(radius<=0 || length<=0 || viscosity<=0) throw new Error('Inputs must be positive numbers.');
        const R = (8 * viscosity * length) / (Math.PI * Math.pow(radius,4));
        document.getElementById('resResult').textContent = `R = ${R.toExponential(3)} Pa·s/m²`;
        document.getElementById('R').value = R.toExponential(3);
      }catch(e){ alert('Invalid resistance input:\n' + e.message); }
    });

    let chartInstances = [];
    function clearCharts(){
      chartInstances.forEach(c=>{ try{ c.destroy(); }catch(e){} });
      chartInstances = [];
      const grid = document.getElementById('chartsGrid'); grid.innerHTML='';
      for(let i=0;i<6;i++){
        const card = document.createElement('div'); card.className='chart-card';
        const title = document.createElement('div'); title.className='chart-title small'; title.textContent = `Vo=...`;
        const canvas = document.createElement('canvas'); canvas.id = 'chart'+i; canvas.height=200;
        card.appendChild(title); card.appendChild(canvas);
        grid.appendChild(card);
      }
    }

    clearCharts();

    document.getElementById('genGraph').addEventListener('click', ()=>{
      try{
        const Pm_g = toNum(document.getElementById('Pm').value);
        const t = toNum(document.getElementById('time').value);
        const Vo_user = toNum(document.getElementById('volume').value);
        const R = toNum(document.getElementById('R').value);
        const mode = Array.from(document.getElementsByName('mode')).find(r=>r.checked).value;
        const Pm_abs = Po_psi + Pm_g; // gauge to abs psi
        const Pm = Pm_abs * 6894.76;

        // prepare canvases
        clearCharts();
        const vols = [Vo_user,5,10,15,20,25];

        vols.forEach((Vo_iter,i)=>{
          const ctx = document.getElementById('chart'+i).getContext('2d');
          const titleDiv = ctx.canvas.parentNode.querySelector('.chart-title');
          try{
            let result;
            if(mode==='positive'){
              result = calc_curve_positive(Pm, t, R, Vo_iter);
            } else {
              result = calc_curve_negative(Pm, t, R, Vo_iter);
            }
            const dataArr = result.data.slice();
            // sort by time
            dataArr.sort((a,b)=>a[0]-b[0]);
            const times = dataArr.map(d=>d[0]);
            const pressures = dataArr.map(d=>d[1]);

            titleDiv.textContent = `Vo=${Vo_iter} mL | ΔV=${result.dV.toFixed(3)} mL | Pi=${result.Pt_g.toFixed(2)} psi`;

            const cfg = {
              type:'line',
              data:{labels:times, datasets:[{label:'P (psi)',data:pressures,fill:false, borderWidth:1.2, tension:0.2}]},
              options:{
                responsive:true, maintainAspectRatio:false,
                scales:{x:{type:'linear', title:{display:true,text:'t (s)'}}, y:{title:{display:true,text:'P (psi)'}}
              }}
            };
            const chart = new Chart(ctx, cfg);
            chartInstances.push(chart);

            // shade area up to t
            // Chart.js v4: add a filled dataset from 0..t
            const cutoffIndex = times.findIndex(tt=>tt>t);
            const fillTo = cutoffIndex===-1?times.length-1:cutoffIndex;
            const fillData = pressures.slice(0, fillTo+1);
            const fillTimes = times.slice(0, fillTo+1);
            const fillDs = {label:'Area', data:fillData, fill:true, borderWidth:0, tension:0.2, showLine:false};
            // create an overlay chart for filling
            const overlayCfg = JSON.parse(JSON.stringify(cfg));
            overlayCfg.data.datasets = [overlayCfg.data.datasets[0], fillDs];
            // tweak dataset colors based on mode
            if(mode==='positive'){
              overlayCfg.data.datasets[0].borderColor='blue'; overlayCfg.data.datasets[1].backgroundColor='rgba(135,206,235,0.4)';
            } else { overlayCfg.data.datasets[0].borderColor='red'; overlayCfg.data.datasets[1].backgroundColor='rgba(250,128,114,0.4)'; }
            chart.destroy();
            const chart2 = new Chart(ctx, overlayCfg);
            chartInstances.push(chart2);

          }catch(e){
            titleDiv.textContent = `Failed: ${e.message}`;
            // draw empty canvas text
            ctx.font = '14px serif'; ctx.fillStyle='red'; ctx.fillText('Failed: '+e.message,10,50);
          }
        });

      }catch(e){ alert('Invalid input:\n' + e.message); }
    });
  </script>
</body>
</html>
