<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Unified Pressure Calculator + Resistance Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
  <style>
    :root{--bg:#f4f7fb;--left:#ffffff;--right:#ffffff;--accent:#2E8B57}
    body{font-family:'Times New Roman',Times,serif;background:var(--bg);margin:0;padding:18px}
    .container{display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start}
    .panel{background:#fff;border-radius:8px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h2{margin:6px 0 12px;font-size:18px}
    label{display:block;margin-top:8px;font-size:14px}
    input[type=text]{width:100%;padding:8px;font-size:14px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    button{cursor:pointer;padding:10px 12px;border-radius:8px;border:none;font-weight:700}
    .btn-primary{background:#4682B4;color:white}
    .btn-green{background:var(--accent);color:white}
    .res-box{margin-top:10px;padding:8px;background:#222;color:#fff;border-radius:6px}
    .mode-row{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .charts-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}

    /* ðŸ”¥ FIXED GRAPH SIZE â€” prevents stretching, elongation, resizing */
    .chart-card{
      width:100%;
      height:260px;          /* Fixed height */
      position:relative;
    }
    .chart-card canvas{
      width:100% !important;
      height:100% !important; /* Force fixed height */
      max-width:100% !important;
      max-height:100% !important;
    }

    @media(max-width:900px){
      .container{grid-template-columns:1fr;}
      .charts-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- LEFT PANEL -->
    <div class="panel">
      <h2>Resistance Calculation</h2>
      <label>Length [m]:<input id="length" type="text" value="0.1"></label>
      <label>Radius [m]:<input id="radius" type="text" value="0.001"></label>
      <label>Viscosity [PaÂ·s]:<input id="viscosity" type="text" value="0.001"></label>
      <button id="calcRes" class="btn-primary" style="margin-top:12px">Calculate Resistance</button>
      <div class="res-box" id="resResult">R = </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel">
      <h2>Unified Pressure Calculator (Positive / Negative)</h2>

      <div class="mode-row">
        <div style="font-weight:700">Mode:</div>
        <label><input type="radio" name="mode" value="positive" checked> Positive</label>
        <label><input type="radio" name="mode" value="negative"> Negative</label>
      </div>

      <label>Target Pressure [psi gauge]:<input id="Pm" type="text" value="0"></label>
      <label>Time [s]:<input id="time" type="text" value="60"></label>
      <label>User Initial Volume [mL]:<input id="volume" type="text" value="1"></label>
      <label>Resistance [PaÂ·s/mÂ²]:<input id="R" type="text" value="0.001"></label>

      <button id="genGraph" class="btn-green" style="margin-top:12px">Generate Graph</button>

      <div class="charts-grid" id="chartsGrid"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    /* --- CONSTANTS --- */
    const Po_psi = 14.7;
    const Po = Po_psi * 6894.76;
    const MAX_RUNTIME = 7000;
    const MAX_POINTS = 5000;
    const EPS = 1e-10;

    function toNum(v){ const n=parseFloat(v); return isFinite(n)?n:0; }
    function now(){ return performance.now(); }

    function solveSecant(f,x0,x1,tol=1e-8,maxIter=600){
      try{
        let f0=f(x0), f1=f(x1);
        if(!isFinite(f0)||!isFinite(f1)) return null;
        for(let i=0;i<maxIter;i++){
          if(Math.abs(f1)<tol) return x1;
          const d=f1-f0;
          if(Math.abs(d)<1e-18) return null;
          const x2=x1-f1*(x1-x0)/d;
          x0=x1; f0=f1;
          x1=x2; f1=f(x1);
          if(!isFinite(f1)) return null;
        }
        return null;
      }catch{ return null; }
    }

    /* -------- POSITIVE CURVE -------- */
    function calc_curve_positive(Pm_pa,t,R,Vo_ml){
      const start=now();
      const Vo=Vo_ml/1e6;

      let Pi = Math.max(Pm_pa+100, Po+1);
      let Pt = Po+1;

      function eqn(P,PiL){
        if(P<=Po+EPS||PiL<=Po+EPS) return NaN;
        const A = Math.log(PiL-Po)-Math.log(PiL)+Po/PiL;
        return Math.log(P-Po)-Math.log(P)+Po/P - (Po/(Vo*R))*t - A;
      }

      let tries=0;
      while(Pt < Pm_pa){
        if(now()-start > MAX_RUNTIME) throw "Timeout";
        const sol = solveSecant(p=>eqn(p,Pi), Pm_pa*0.9, Pm_pa*1.01);
        if(!sol){ Pi+=20; tries++; if(tries>2000) throw "No conv"; continue; }
        Pt = sol;
        Pi+=20;
      }

      const A = Math.log(Pt-Po)-Math.log(Pt)+Po/Pt;
      const data=[];
      let P=Pt, count=0, dP=0.01*6894.76;

      while(P>Po+EPS && count<MAX_POINTS){
        const tt = -(Vo*R/Po)*((Math.log(P-Po)-Math.log(P)+Po/P)-A);
        if(isFinite(tt)) data.push([tt,(P-Po)/6894.76]);
        P-=dP;
        count++;
      }

      if(data.length===0) data.push([0,(Pt-Po)/6894.76]);
      if(data[data.length-1][0]<t) data.push([t,data[data.length-1][1]]);

      return { data };
    }

    /* -------- NEGATIVE CURVE -------- */
    function calc_curve_negative(Pm_pa,t,R,Vo_ml){
      const start=now();
      const Vo=Vo_ml/1e6;

      let Pi = Math.min(Pm_pa-100, Po-1);
      let Pt = Po-100;

      function eqn(P,PiL){
        if(P>=Po-EPS||PiL>=Po-EPS) return NaN;
        const A = Math.log(Po-PiL)-Math.log(Po)+PiL/Po;
        return Math.log(Po-P)-Math.log(Po)+P/Po - (Po/(Vo*R))*t - A;
      }

      let tries=0;
      while(Pt > Pm_pa){
        if(now()-start > MAX_RUNTIME) throw "Timeout";
        const sol = solveSecant(p=>eqn(p,Pi), Pm_pa*0.9, Pm_pa*1.05);
        if(!sol){ Pi-=20; tries++; if(tries>2000) throw "No conv"; continue; }
        Pt = sol;
        Pi-=20;
      }

      const A = Math.log(Po-Pt)-Math.log(Po)+Pt/Po;
      const data=[];
      let P=Pt, count=0;

      while(P<Po-1 && count<MAX_POINTS){
        const tt = -(Vo*R/Po)*((Math.log(Po-P)-Math.log(Po)+P/Po)-A);
        if(isFinite(tt)) data.push([tt,(P-Po)/6894.76]);
        P+=500;
        count++;
      }

      if(data.length===0) data.push([0,(Pt-Po)/6894.76]);
      if(data[data.length-1][0]<t) data.push([t,data[data.length-1][1]]);

      return { data };
    }

    /* --- UI: Build Chart Boxes --- */
    let charts=[];

    function clearCharts(){
      charts.forEach(c=>c.destroy());
      charts=[];
      const grid=document.getElementById("chartsGrid");
      grid.innerHTML="";
      for(let i=0;i<6;i++){
        grid.innerHTML += `
          <div class="chart-card">
            <div class="chart-title small">Vo...</div>
            <canvas id="chart${i}"></canvas>
          </div>
        `;
      }
    }
    clearCharts();

    /* --- Resistance Button --- */
    document.getElementById("calcRes").onclick = ()=>{
      const L=toNum(lengthEl.value), r=toNum(radiusEl.value), mu=toNum(viscosityEl.value);
      if(L<=0||r<=0||mu<=0) return alert("Invalid");
      const R=(8*mu*L)/(Math.PI*r**4);
      resResult.textContent=`R = ${R.toExponential(3)} PaÂ·s/mÂ²`;
      REl.value=R.toExponential(3);
    };

    const lengthEl=document.getElementById("length"),
          radiusEl=document.getElementById("radius"),
          viscosityEl=document.getElementById("viscosity"),
          resResult=document.getElementById("resResult"),
          REl=document.getElementById("R");

    /* --- MAIN GRAPH BUTTON --- */
    document.getElementById("genGraph").onclick = ()=>{

      const Pm_g = toNum(document.getElementById("Pm").value);
      const t = toNum(document.getElementById("time").value);
      const tCutoff = t+60;
      const Vo_user = toNum(document.getElementById("volume").value);
      const R = toNum(document.getElementById("R").value);
      const mode=document.querySelector("input[name='mode']:checked").value;
      const Pm_abs = (Po_psi+Pm_g)*6894.76;

      clearCharts();

      const vols=[Vo_user,5,10,15,20,25];

      vols.forEach((vol,i)=>{
        const ctx=document.getElementById("chart"+i).getContext("2d");
        const title=ctx.canvas.parentNode.querySelector(".chart-title");

        try{
          const result = (mode==="positive")
              ? calc_curve_positive(Pm_abs,t,R,vol)
              : calc_curve_negative(Pm_abs,t,R,vol);

          let data = result.data.filter(d=>
            isFinite(d[0]) && isFinite(d[1]) && Math.abs(d[1]) < 1e6
          );

          data = data.filter(d=>d[0] <= tCutoff);
          if(data.length===0) throw "No data";

          data.sort((a,b)=>a[0]-b[0]);

          if(data.length>MAX_POINTS){
            const step=Math.ceil(data.length/MAX_POINTS);
            data=data.filter((_,idx)=>idx%step===0);
          }

          const points=data.map(d=>({x:d[0],y:d[1]}));
          const pressures=points.map(p=>p.y);

          const yMin=Math.min(...pressures);
          const yMax=Math.max(...pressures);
          const pad=0.1*(yMax-yMin || 1);

          title.textContent = `Vo=${vol} mL`;

          const chart=new Chart(ctx,{
            type:"line",
            data:{datasets:[{
              data:points,
              borderWidth:1.2,
              tension:0.2,
              pointRadius:0
            }]},
            options:{
              responsive:false,   /* ðŸ”¥ prevent resizing */
              maintainAspectRatio:false,
              parsing:false,
              scales:{
                x:{
                  type:"linear",
                  min:0,
                  max:tCutoff,
                  title:{text:"t (s)",display:true}
                },
                y:{
                  min:yMin-pad,
                  max:yMax+pad,
                  ticks:{maxTicksLimit:6},
                  title:{text:"P (psi)",display:true}
                }
              }
            }
          });

          charts.push(chart);

        }catch(e){
          title.textContent="Failed: "+e;
          ctx.fillStyle="red";
          ctx.fillText("Error: "+e,10,50);
        }
      });

    };
  </script>
</body>
</html>
